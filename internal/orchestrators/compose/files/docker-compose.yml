# --- Canasta Stack for Docker Compose ---
#
# !!! DO NOT EDIT THIS FILE !!!
# ANY EDITS YOU MAKE HERE WILL BE OVERRIDDEN ON FUTURE UPDATES OF THE CANASTA STACK FOR DOCKER COMPOSE
# THIS FILE SHOULD ONLY BE EDITED BY THE DEVELOPERS OF CANASTA
#
# Only edits to docker-compose.override.yml are officially supported by Canasta.

x-logging: &default-logging
  driver: json-file
  options:
    max-size: "50m"
    max-file: "3"

services:
  db:
    image: docker.io/library/mariadb:11.4
    command: >
      bash -c "
        chown -R mysql:mysql /var/log/mysql &&
        (while sleep 86400; do LOG=/var/log/mysql/error.log; test -f $$LOG && test $$(wc -c <$$LOG) -gt 10485760 && mv $$LOG $$LOG.1 && mariadb-admin -u root -p$$MYSQL_ROOT_PASSWORD flush-logs 2>/dev/null; done) &
        exec docker-entrypoint.sh mariadbd --expire_logs_days=3 --secure-file-priv='' --log-error=/var/log/mysql/error.log
      "
    user: root  # Required so the entrypoint can chown /var/log/mysql before dropping to mysql
    cap_add:
      - SYS_NICE  # CAP_SYS_NICE, fix error mbind: Operation not permitted
    restart: unless-stopped
    logging: *default-logging
    environment:
      - MYSQL_ROOT_HOST=%
      - MYSQL_ROOT_PASSWORD=${MYSQL_PASSWORD}
    healthcheck:
      test: ["CMD", "mariadb-admin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 60s
    volumes:
      - ./_initdb:/docker-entrypoint-initdb.d
      - mysql-data-volume:/var/lib/mysql
      - ./my.cnf:/etc/my.cnf
      - mysql-logs:/var/log/mysql

  web:
    image: ${CANASTA_IMAGE:-ghcr.io/canastawiki/canasta:latest}
    restart: unless-stopped
    logging: *default-logging
    extra_hosts:
      - "gateway.docker.internal:host-gateway"
    depends_on:
      db:
        condition: service_healthy
    environment:
      # Sourced from .env
      - MW_SITE_SERVER=${MW_SITE_SERVER:-https://localhost}
      - MW_SECRET_KEY=${MW_SECRET_KEY}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - PHP_UPLOAD_MAX_FILESIZE=${PHP_UPLOAD_MAX_FILESIZE:-10M}
      - PHP_POST_MAX_SIZE=${PHP_UPLOAD_MAX_FILESIZE:-10M}
      - PHP_MAX_INPUT_VARS=${PHP_MAX_INPUT_VARS:-1000}
    volumes:
      - ./extensions:/var/www/mediawiki/w/user-extensions
      - ./skins:/var/www/mediawiki/w/user-skins
      - ./config:/mediawiki/config
      - ./images:/mediawiki/images
      - ./public_assets:/mediawiki/public_assets
      - mediawiki-logs:/var/log/mediawiki

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.10.2
    profiles:
      - elasticsearch
    restart: unless-stopped
    logging: *default-logging
    environment:
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ulimits:
      memlock:
        soft: -1
        hard: -1
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:9200/_cluster/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 30s
    volumes:
      - elasticsearch:/usr/share/elasticsearch/data

  caddy:
    image: docker.io/library/caddy:2.10.2-alpine
    restart: unless-stopped
    logging: *default-logging
    ports:
      - "${HTTP_PORT:-80}:80"
      - "${HTTPS_PORT:-443}:443"
    environment:
      - MW_SITE_FQDN=${MW_SITE_FQDN:-localhost}
    volumes:
      - caddy-data:/data
      - ./config/Caddyfile:/etc/caddy/Caddyfile
      - ./config/Caddyfile.site:/etc/caddy/Caddyfile.site
      - ./config/Caddyfile.global:/etc/caddy/Caddyfile.global
      - caddy-logs:/var/log/caddy

  varnish:
    image: docker.io/library/varnish:7.0.2-alpine
    restart: unless-stopped
    logging: *default-logging
    depends_on:
      web:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "varnishadm", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    volumes:
       - ./config/default.vcl:/etc/varnish/default.vcl:ro
    tmpfs:
      - /var/lib/varnish:exec

  opensearch:
    image: opensearchproject/opensearch:2.11.1
    profiles:
      - observable
    restart: unless-stopped
    logging: *default-logging
    environment:
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      - plugins.security.disabled=true
      - "OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m"
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - opensearch-data:/usr/share/opensearch/data

  logstash:
    image: opensearchproject/logstash-oss-with-opensearch-output-plugin:8.9.0
    # root is required to read log files owned by other containers' users
    user: root
    profiles:
      - observable
    restart: unless-stopped
    logging: *default-logging
    entrypoint: >
      bash -c "mkdir -p /usr/share/logstash/data/sincedb && exec /usr/local/bin/docker-entrypoint"
    depends_on:
      - opensearch
    volumes:
      - ./config/logstash/pipeline:/usr/share/logstash/pipeline:ro
      - logstash-sincedb:/usr/share/logstash/data/sincedb
      - mediawiki-logs:/var/log/mediawiki:ro
      - caddy-logs:/var/log/caddy:ro
      - mysql-logs:/var/log/mysql:ro
    environment:
      - "LS_JAVA_OPTS=-Xms256m -Xmx256m"

  opensearch-dashboards:
    image: opensearchproject/opensearch-dashboards:2.11.1
    profiles:
      - observable
    restart: unless-stopped
    logging: *default-logging
    depends_on:
      - opensearch
    environment:
      - OPENSEARCH_HOSTS=http://opensearch:9200
      - SERVER_BASEPATH=/opensearch
      - SERVER_REWRITEBASEPATH=true
      - DISABLE_SECURITY_DASHBOARDS_PLUGIN=true

  observable-init:
    image: docker.io/library/alpine:3.21
    profiles:
      - observable
    restart: "no"
    logging: *default-logging
    depends_on:
      - opensearch
      - opensearch-dashboards
    volumes:
      - ./scripts/observable-init.sh:/observable-init.sh:ro
    entrypoint: /bin/sh /observable-init.sh

volumes:
  mysql-data-volume:
  elasticsearch:
  caddy-data:
  opensearch-data:
  mediawiki-logs:
  caddy-logs:
  mysql-logs:
  logstash-sincedb:
